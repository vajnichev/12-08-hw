# Домашнее задание к занятию «Резервное копирование баз данных» - ВАЖНИЧЕВ ГЕОРГИЙ

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

---
Для финансовой компании, которая хочет повысить надежность резервного копирования и обеспечить возможность быстрого восстановления данных, стоит рассмотреть несколько подходов. 

---
#### Решение:

### 1.1 Полное восстановление данных за предыдущий день

Чтобы обеспечить восстановление данных в полном объёме за предыдущий день, можно использовать полное резервное копирование, которое выполняется ежедневно в определенное время, например, ночью или в период минимальной нагрузки на систему.

Полное резервное копирование включает в себя копирование всех данных и может выполняться по следующему графику:
- Каждый день создаётся полный снимок всей базы данных.
- Такие бэкапы можно хранить на внешних серверах или облачном хранилище для дополнительной безопасности.

Достоинства:
- Все данные легко восстанавливаются из одного резервного копирования.
- Упрощает управление, так как есть одно место для восстановления данных за целый день.

Недостатки:
- Требует значительных ресурсов хранения и времени для завершения полной копии, особенно на больших объёмах данных.

---

### 1.2 Восстановление данных за час до предполагаемой поломки

Для восстановления данных с точностью до часа, важно использовать инкрементное или дифференциальное резервное копирование совместно с регулярными журналами транзакций.

1. Инкрементное резервное копирование:
   - Каждый час после выполнения полного резервного копирования создаются инкрементные копии, в которых фиксируются только изменения с момента последнего бэкапа.
   - При сбое можно восстановить данные до нужного времени, применив последовательность инкрементных бэкапов к последнему полному бэкапу.

2. Журналирование транзакций:
   - Использование журналов транзакций позволяет восстанавливать базу до определенного состояния (point-in-time recovery) с точностью до одной транзакции. Если база поддерживает такую функцию, то можно восстанавливать данные с точностью до определенного времени.
   - Журналы транзакций могут архивироваться и записываться каждый час или чаще, что даст возможность «откатиться» до состояния, зафиксированного часом ранее.

Достоинства:
- Минимальный объём хранения, поскольку копируются только изменения.
- Поддержка точного времени восстановления данных в случае сбоя.

Недостатки:
- Сложность восстановления, поскольку необходимо последовательно накладывать инкрементные бэкапы на полное копирование.
- Более высокий риск ошибки при восстановлении, так как требуется больше этапов.

---

### 1.3 Мгновенное переключение на работающую базу при поломке

Для обеспечения бесперебойной работы базы данных при сбое можно использовать репликацию данных и кластеризацию. Репликация данных создает синхронизированные копии базы, а кластеризация позволяет автоматически переключаться на рабочий экземпляр базы при отказе основного.

1. Репликация:
   - Настраивается основная база данных (Primary) и резервная (Secondary), которая получает все обновления данных в режиме реального времени.
   - В случае сбоя основного сервера резервная база может быть настроена на автоматическое поднятие в роли основной.
  
2. Кластеризация и отказоустойчивость (Failover Clustering):
   - В кластере базы данных (например, с использованием PostgreSQL, MySQL или других систем, поддерживающих такую функцию) можно настроить автоматическое переключение на рабочий экземпляр в случае отказа основной базы.
   - При поломке система автоматически переключается на один из резервных узлов, что обеспечивает непрерывность работы.

3. Географически распределенные репликации:
   - Данные могут реплицироваться на географически удаленные серверы, что позволяет быстро восстановить доступ к базе в случае сбоя в одном из центров обработки данных.

Достоинства:
- Обеспечивает практически моментальное переключение на резервный сервер, минимизируя простой.
- Снижает вероятность потери данных, так как репликация происходит практически в реальном времени.

Недостатки:
- Требует сложной настройки и значительных ресурсов для поддержки реплицированной или кластеризованной инфраструктуры.
- Высокие затраты на оборудование и обслуживание дополнительных серверов.

--- 

Для финансовой компании, где надежность и минимизация простоев особенно важны, 

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---

#### Решение:

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

Команда резервирования данных:
```bash
pg_dump sakila > sakiladb.sql
```
Если нужен другой формат, то указываем параметр -Fc: 
```bash
pg_dump -Fc sakila > sakiladb.dump
```
Если БД принадлежит другому пользователю, то указываем параметр -U username:
```bash
pg_dump -U username sakila > sakiladb.sql
```
[Ссылка на документацию PostgreSQL, pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html)

Команда восстановления БД:
```bash
pg_restore -d sakila sakiladb.sql
```
[Ссылка на документацию PostgreSQL, pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html)

### 2.1.* Возможность автоматизации процесса резервного копирования и восстановления

1. Скрипты на Bash и планировщик задач (cron):
   - Создаётся скрипт, который выполняет команды `pg_dump` для регулярного резервного копирования.
   - Этот скрипт можно настроить в `cron` для регулярного запуска, например, каждый день или каждый час.

Пример скрипта для автоматического резервного копирования:

```
#!/bin/bash

# Параметры для PostgreSQL
USER="postgres"
DB_NAME="mydatabase"
BACKUP_DIR="/backup"
DATE=$(date +\%Y-\%m-\%d)

# Выполнение резервного копирования
pg_dump -U $USER -d $DB_NAME -F c -f "$BACKUP_DIR/${DB_NAME}_$DATE.dump"

# Удаление старых резервных копий (старше 7 дней)
find $BACKUP_DIR -type f -name "*.dump" -mtime +7 -exec rm {} \;
```

Добавление задания в `cron` для ежедневного запуска в 2:00 утра:

```
0 2 * * * /path/to/backup_script.sh
```

2. Использование систем управления резервным копированием (например, Bacula, pgBackRest):
   - `pgBackRest` — это инструмент для резервного копирования PostgreSQL, который поддерживает инкрементное копирование и репликацию.
   - Такие системы позволяют создать продвинутые правила, включая шифрование, сжатие, проверку целостности резервных копий и уведомления.

3. Автоматизация с помощью Ansible или других инструментов управления конфигурацией:
   - Ansible может выполнять резервное копирование, настройку расписания и проверки состояния PostgreSQL на удалённых серверах, что особенно полезно в распределённых системах.

4. Облачные службы:
   - Если база данных развернута в облаке, некоторые провайдеры предлагают встроенные инструменты резервного копирования и восстановления с поддержкой расписания (например, Amazon RDS, Google Cloud SQL).
---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

*Приведите ответ в свободной форме.*

#### Решение:

Так как инкрементное резервное копирование использует полную копию как начальную точку, то сначала нужно сделать полную резервную копию. Далее инкрементное резервное копирование:
```bash
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi \
   backup-to-image
```
В данном примере используется опция --incremental-base=history:last_backup, которая извлекает LSN последней успешной полной или частичной резервной копии (не TTS) из mysql.backup_history таблицы и на этой основе выполняет инкрементную резервную копию.

[Ссылка на документацию MySQL](https://dev.mysql.com/doc/mysql-enterprise-backup/8.2/en/mysqlbackup.incremental.html#meb-incremental-considerations)

### 3.1.* Преимущества использования реплики по сравнению с обычным резервным копированием

Использование реплики базы данных в некоторых случаях может дать значительные преимущества по сравнению с обычным резервным копированием. Вот несколько сценариев, когда репликация будет более выгодной:

1. Минимизация времени простоя:
   - Репликация позволяет практически моментально переключиться на копию базы данных в случае сбоя основного сервера, тогда как восстановление из резервной копии требует времени, особенно для больших объёмов данных.

2. Снижение нагрузки на основную базу данных:
   - Реплика может быть использована для обработки запросов на чтение (например, для отчетности), что снижает нагрузку на основной сервер и улучшает производительность при большом количестве операций чтения.

3. Повышение отказоустойчивости и доступности:
   - Репликация помогает создавать резервные копии в реальном времени, так что в случае сбоя данные теряются минимально, в отличие от традиционного резервного копирования, при котором данные могут быть утеряны до последнего выполнения бэкапа.

4. Поддержка географически распределённых пользователей:
   - Репликация позволяет разместить копии базы данных ближе к пользователям в разных регионах, что ускоряет доступ к данным и снижает задержки.

5. Тестирование и обновления:
   - Реплика может использоваться для тестирования обновлений и изменений перед их применением к основной базе, что снижает риск ошибок и потерь данных в боевой системе.

Таким образом, репликация выгодна при высоких требованиях к отказоустойчивости, доступности, производительности и минимизации времени простоя. В то время как обычное резервное копирование подходит для долгосрочного хранения данных и для катастрофического восстановления, репликация позволяет обеспечить непрерывность бизнеса и более оперативное восстановление при сбоях.
---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.
